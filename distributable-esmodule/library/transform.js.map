{"version":3,"sources":["../../source/library/transform.js"],"names":["DefaultBabel","ModuleBabel","ESLint","FileSystem","_Format","Is","JSON5","Lex","Link","Load","Parse","Path","AndAttributeNode","AttributeNode","BlockNode","EachNode","Package","UnrecognizedMessageTransformError","Babel","Lint","FilePath","_URL","fileURLToPath","import","meta","url","format","Format","Require","_createRequire","Transform","getASTFromContent","content","option","lexerOutput","path","parserOutput","loaderOutput","AST","getSourceFromContent","blockNode","blockSource","getSource","source","__forEach","toString","__addAndAttribute","__getAttributeValue","__addAttribute","name","version","relative","local","_getLocalFromSource","getFunctionSourceFromContent","map","join","getFunctionFromContent","formatSource","fn","eval","getASTFromPath","readFile","getSourceFromPath","getFunctionSourceFromPath","getFunctionFromPath","createModuleFromPath","extension","extname","modulePath","writeFile","toLowerCase","configuration","parse","resolve","env","code","sourceOut","transformAsync","lint","result","lintText","pattern","messages","filter","message","ruleId","match","not","null","exec","reduce","accumulator","undefined","Object","keys"],"mappings":"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","sourcesContent":["import DefaultBabel, * as ModuleBabel from '@babel/core'\nimport ESLint from 'eslint'\nimport FileSystem from 'fs-extra'\nimport _Format from 'prettier'\nimport Is from '@pwn/is'\nimport JSON5 from 'json5'\nimport Lex from 'pug-lexer'\nimport Link from 'pug-linker'\nimport Load from 'pug-load'\nimport Parse from 'pug-parser'\nimport Path from 'path'\n\nimport AndAttributeNode from './node/and-attribute-node.js'\nimport AttributeNode from './node/attribute-node.js'\nimport BlockNode from './node/block-node.js'\nimport EachNode from './node/each-node.js'\nimport { Package } from './package.js'\n\nimport { UnrecognizedMessageTransformError } from './error/unrecognized-message-transform-error.js'\n\nconst Babel = DefaultBabel || ModuleBabel\nconst { ESLint: Lint } = ESLint\nconst FilePath = __filePath\nconst { format: Format } = _Format\nconst Require = __require\n\nclass Transform {\n  \n  static getASTFromContent(content, option = { 'path': '(anonymous)' }) {\n    // console.log('Transform.getASTFromContent(content, option) { ... }')\n\n    let lexerOutput = Lex(content, { 'filename': option.path })\n    let parserOutput = Parse(lexerOutput, { 'filename': option.path })\n    let loaderOutput = Load(parserOutput, { 'lex': Lex, 'parse': Parse })\n    let AST = Link(loaderOutput)\n\n    return AST\n\n  }\n\n  static async getSourceFromContent(content, option = { 'path': '(anonymous)' }) {\n    // console.log('Transform.getSourceFromContent(content, option) { ... }')\n\n    let AST = this.getASTFromContent(content, option)\n    let blockNode = new BlockNode(AST, option)\n    let blockSource = await blockNode.getSource()\n\n    let source =  ` function ${EachNode.__forEach.toString()}\n                    function ${AndAttributeNode.__addAndAttribute.toString()}\n                    function ${AttributeNode.__getAttributeValue.toString()}\n                    function ${AttributeNode.__addAttribute.toString()}\n                    function __getNode(__option = {}) { \n                      // Powered by ${Package.name} v${Package.version}\n                      // FilePath = '${Path.relative('', FilePath)}'\n                      const __node = []\n                      ${blockSource}\n                      return __node\n                    }`\n\n    let local = await this._getLocalFromSource(source)\n\n    return { source, local }\n\n  }\n\n  static async getFunctionSourceFromContent(content, option = { 'path': '(anonymous)' }) {\n    // console.log('Transform.getFunctionSourceFromContent(content, option) { ... }')\n\n    let { source, local } = await this.getSourceFromContent(content, option)\n\n    local = local\n      .map((local) => `const { ${local} } = __local`)\n      .join('\\n')\n\n    source =  ` function __getNode(__local = {}, __option = {}) {\n                  // Powered by ${Package.name} v${Package.version}\n                  // FilePath = '${Path.relative('', FilePath)}'\n                  ${local}\n                  ${source} \n                  return __getNode(__option) \n                }`\n\n    return source\n\n  }\n\n  static async getFunctionFromContent(content, option = { 'path': '(anonymous)' }) {\n    // console.log('Transform.getFunctionFromContent(content, option) { ... }')\n\n    let source = null\n    source = await this.getFunctionSourceFromContent(content, option)\n    source = await this.formatSource(source)\n\n    let fn = null\n    eval(`fn = ${source}`)\n\n    return fn\n\n  }\n\n  static async getASTFromPath(path) {\n    // console.log(`Transform.getASTFromPath('${Path.relative('', path)}') { ... }`)\n\n    let content = await FileSystem.readFile(path, { 'encoding': 'utf-8' })\n    let AST = this.getASTFromContent(content, { 'path': path })\n\n    return AST\n\n  }\n\n  static async getSourceFromPath(path) {\n    // console.log(`Transform.getSourceFromPath('${Path.relative('', path)}') { ... }`)\n\n    let content = await FileSystem.readFile(path, { 'encoding': 'utf-8' })\n    let source = await this.getSourceFromContent(content, { 'path': path })\n\n    return source\n\n  }\n\n  static async getFunctionSourceFromPath(path) {\n    // console.log('Transform.getFunctionSourceFromPath('${Path.relative('', path)}') { ... }`)\n\n    let content = await FileSystem.readFile(path, { 'encoding': 'utf-8' })\n    let source = await this.getFunctionSourceFromContent(content, { 'path': path })\n\n    return source\n\n  }\n\n  static async getFunctionFromPath(path) {\n    // console.log(`Transform.getFunctionFromPath('${Path.relative('', path)}') { ... }`)\n\n    let content = await FileSystem.readFile(path, { 'encoding': 'utf-8' })\n    let fn = await this.getFunctionFromContent(content, { 'path': path })\n\n    return fn\n\n  }\n\n  static async createModuleFromPath(path, option = { 'encoding': 'utf-8', 'flag': 'wx' }) {\n    // console.log(`Transform.createModuleFromPath('${Path.relative('', path)}') { ... }`)\n\n    let source = null\n    source = await this.getFunctionSourceFromPath(path)\n    source =  ` import CreateVirtualNode from 'virtual-dom/h.js'\n                import _ConvertToVirtualNode from 'html-to-vdom'\n                import VirtualNode from 'virtual-dom/vnode/vnode.js'\n                import VirtualText from 'virtual-dom/vnode/vtext.js'\n                const ConvertToVirtualNode = _ConvertToVirtualNode({ 'VNode': VirtualNode, 'VText': VirtualText })\n                ${source}\n                export default function(__local = {}, __option = { 'createNode': CreateVirtualNode, 'convertToNode': ConvertToVirtualNode }) { \n                  // Powered by ${Package.name} v${Package.version}\n                  // FilePath = '${Path.relative('', FilePath)}'\n                  return __getNode(__local, __option) \n                }`\n\n    source = await this.formatSource(source)\n\n    let extension = Path.extname(FilePath)\n    let modulePath = `${path}${extension}`\n\n    await FileSystem.writeFile(modulePath, source, option)\n\n    return import(modulePath)\n\n  }\n\n  static async formatSource(source) {\n\n    let extension = null\n    extension = Path.extname(FilePath)\n    extension = extension.toLowerCase()\n\n    let configuration = null\n    configuration = JSON5.parse(await FileSystem.readFile(Require.resolve('./transform.babelrc.json')), { 'encoding': 'utf-8' })\n    configuration = configuration.env[extension === '.cjs' ? 'cjs' : 'esm']\n    \n    let { code: sourceOut } = await Babel.transformAsync(source, configuration)\n\n    sourceOut = Format(sourceOut, {\n      'arrowParens': 'always',\n      'bracketSpacing': true,\n      'parser': 'babel',\n      'quoteProps': 'consistent',\n      'semi': false,\n      'singleQuote': true,\n      'tabWidth': 2,\n      'trailingComma': 'none'\n    })\n\n    return sourceOut\n\n  }\n\n  static async _getLocalFromSource(source) {\n\n    let configuration = JSON5.parse(await FileSystem.readFile(Require.resolve('./transform.eslintrc.json')), { 'encoding': 'utf-8' })\n    let lint = new Lint({ 'baseConfig': configuration })\n\n    let result = await lint.lintText(source)\n    let pattern = /^'(.*)' is not defined.$/i\n\n    let local = null\n    local = result[0].messages\n      .filter((message) => message.ruleId === 'no-undef')\n      .map((message) => message.message)\n      .map((message) => {\n\n        let match = null\n\n        if (Is.not.null(match = pattern.exec(message))) {\n          let [ , local ] = match\n          return local\n        } else {\n          throw new UnrecognizedMessageTransformError(message)\n        }\n\n      })\n      .reduce((accumulator, local) => {\n        accumulator[local] = undefined\n        return accumulator\n      }, {})\n\n    local = Object.keys(local)\n\n    return local\n\n  }\n\n}\n\nexport { Transform }"],"file":"transform.js"}